<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MasterDrive - Sistema de Telemetria Profissional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        * { font-family: 'Inter', sans-serif; }
        
        body { 
            background: #f8fafc;
            overflow-x: hidden;
        }
        
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            width: 280px;
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            box-shadow: 4px 0 24px rgba(0,0,0,0.15);
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        
        .sidebar.closed { transform: translateX(-100%); }
        
        .main-content {
            margin-left: 280px;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }
        
        .main-content.expanded { margin-left: 0; }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-trabalhando { background: #d1fae5; color: #065f46; }
        .status-parado { background: #fee2e2; color: #991b1b; }
        .status-manutencao { background: #fef3c7; color: #92400e; }
        .status-sem-apropriacao { background: #e5e7eb; color: #374151; }
        
        .vaga-card {
            background: white;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .vaga-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
            transform: translateY(-2px);
        }
        
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        
        .modal.active { display: flex; }
        
        .timeline-segment {
            height: 32px;
            transition: all 0.3s;
            position: relative;
            cursor: pointer;
        }
        
        .timeline-segment:hover { opacity: 0.8; transform: scaleY(1.1); }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
            border-left: 4px solid;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .toast.success { border-color: #10b981; }
        .toast.error { border-color: #ef4444; }
        .toast.warning { border-color: #f59e0b; }
        .toast.info { border-color: #3b82f6; }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }
        
        .alert-card {
            background: white;
            border-radius: 12px;
            border-left: 4px solid;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }
        
        .alert-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .alert-critical { border-color: #ef4444; }
        .alert-warning { border-color: #f59e0b; }
        .alert-info { border-color: #3b82f6; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; }
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div id="toastContainer"></div>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 text-center shadow-2xl">
            <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-gray-700 font-semibold">Carregando...</p>
        </div>
    </div>
    
    <!-- Timeline Modal -->
    <div id="timelineModal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden">
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 p-6 flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold text-white" id="modalTitle"></h2>
                    <p class="text-blue-100 text-sm" id="modalSubtitle"></p>
                </div>
                <button onclick="closeModal()" class="text-white hover:bg-white hover:bg-opacity-20 rounded-lg p-2 transition-all">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="modalBody" class="p-6 overflow-y-auto max-h-[calc(90vh-100px)]"></div>
        </div>
    </div>
    
    <!-- App Container -->
    <div id="app"></div>

    <script>
        // ============================================
        // CONFIGURA√á√ÉO
        // ============================================
        const CONFIG = {
            API_URL: 'https://script.google.com/macros/s/AKfycbyg3vTDdYTz24nddqFbIGgTjAi_WcUGH1btyrQQ2lsvny_HDwEm-s8EJP5bRNPYpufo8A/exec',
            REFRESH_INTERVAL: 60000
        };
        
        // ============================================
        // ESTADO GLOBAL
        // ============================================
        let state = {
            view: 'dashboard',
            vagas: [],
            selectedDate: getCurrentDate(),
            sidebarOpen: window.innerWidth >= 768,
            filters: {
                search: '',
                status: 'all',
                startDate: getMonthStart(),
                endDate: getCurrentDate()
            },
            alerts: [],
            rules: [],
            dashboardData: null,
            charts: {}
        };
        
        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function getCurrentDate() { return new Date().toISOString().split('T')[0]; }
        function getMonthStart() { const d = new Date(); return new Date(d.getFullYear(), d.getMonth(), 1).toISOString().split('T')[0]; }
        function formatDate(d) { return new Date(d+'T00:00:00').toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }); }
        function formatDateTime(d) { return new Date(d).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }); }
        function showLoading(show = true) { document.getElementById('loadingOverlay').classList.toggle('hidden', !show); }
        
        // ============================================
        // TOAST SYSTEM
        // ============================================
        const Toast = {
            show(message, type = 'info') {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                const icons = { success: '‚úì', error: '‚úï', info: '‚Ñπ', warning: '‚ö†' };
                toast.innerHTML = `<div class="flex items-center gap-3"><span class="text-xl">${icons[type]}</span><p class="font-semibold">${message}</p></div>`;
                container.appendChild(toast);
                setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => toast.remove(), 300);
                }, 4000);
            },
            success(m) { this.show(m, 'success'); },
            error(m) { this.show(m, 'error'); },
            info(m) { this.show(m, 'info'); },
            warning(m) { this.show(m, 'warning'); }
        };
        
        // ============================================
        // API CALLS
        // ============================================
        async function apiCall(action, params = {}) {
            try {
                const url = new URL(CONFIG.API_URL);
                url.searchParams.append('action', action);
                Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
                
                const response = await fetch(url);
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                Toast.error('Erro de conex√£o');
                return { success: false, error: error.message };
            }
        }
        
        async function loadVagas() {
            const result = await apiCall('getVagas', { date: state.selectedDate });
            if (result.success) {
                state.vagas = result.vagas;
                render();
            }
        }
        
        async function loadAlerts() {
            const result = await apiCall('getAlerts');
            if (result.success) {
                state.alerts = result.alerts;
                render();
            }
        }
        
        async function loadRules() {
            const result = await apiCall('getRules');
            if (result.success) {
                state.rules = result.rules;
                render();
            }
        }
        
        async function loadDashboard() {
            const result = await apiCall('getDashboardData', {
                startDate: state.filters.startDate,
                endDate: state.filters.endDate
            });
            if (result.success) {
                state.dashboardData = result.data;
                render();
                setTimeout(renderCharts, 100);
            }
        }
        
        async function saveRule(rule) {
            showLoading();
            const result = await apiCall('saveRule', rule);
            showLoading(false);
            if (result.success) {
                Toast.success('Regra salva com sucesso!');
                await loadRules();
            } else {
                Toast.error('Erro ao salvar regra');
            }
        }
        
        // ============================================
        // NAVIGATION
        // ============================================
        function navigateTo(view) {
            state.view = view;
            state.sidebarOpen = window.innerWidth >= 768;
            
            if (view === 'dashboard') loadDashboard();
            else if (view === 'monitoring') loadVagas();
            else if (view === 'alerts') loadAlerts();
            else if (view === 'settings') loadRules();
            
            render();
        }
        
        function toggleSidebar() {
            state.sidebarOpen = !state.sidebarOpen;
            render();
        }
        
        // ============================================
        // MODAL FUNCTIONS
        // ============================================
        function showTimeline(vaga) {
            const modal = document.getElementById('timelineModal');
            const title = document.getElementById('modalTitle');
            const subtitle = document.getElementById('modalSubtitle');
            const body = document.getElementById('modalBody');
            
            title.textContent = vaga.nome;
            subtitle.textContent = vaga.equipamento || 'Sem equipamento';
            
            body.innerHTML = renderTimelineContent(vaga);
            
            modal.classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('timelineModal').classList.remove('active');
        }
        
        function renderTimelineContent(vaga) {
            if (!vaga.eventos || vaga.eventos.length === 0) {
                return '<p class="text-gray-500 text-center py-8">Nenhum evento registrado</p>';
            }
            
            const dayMinutes = 24 * 60;
            
            return `
                <div class="mb-6">
                    <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Timeline do Dia
                    </h3>
                    
                    <div class="flex justify-between text-xs text-gray-500 mb-2">
                        <span>00:00</span>
                        <span>06:00</span>
                        <span>12:00</span>
                        <span>18:00</span>
                        <span>24:00</span>
                    </div>
                    
                    <div class="flex rounded-lg overflow-hidden border border-gray-200 mb-4">
                        ${vaga.eventos.map(evt => {
                            const minutes = parseTimeToMinutes(evt.tempoTotal);
                            const percentage = (minutes / dayMinutes) * 100;
                            const statusClass = normalizeStatus(evt.status || evt.descricao);
                            const color = getStatusColor(statusClass);
                            
                            return `<div class="timeline-segment" style="width: ${percentage}%; background: ${color}" title="${evt.descricao} - ${evt.tempoTotal}"></div>`;
                        }).join('')}
                    </div>
                    
                    <div class="flex gap-4 flex-wrap text-xs">
                        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-green-500"></div><span>Trabalhando</span></div>
                        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-red-500"></div><span>Parado</span></div>
                        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-yellow-500"></div><span>Manuten√ß√£o</span></div>
                        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-gray-400"></div><span>Sem Apropria√ß√£o</span></div>
                    </div>
                </div>
                
                <div>
                    <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        Eventos Detalhados
                    </h3>
                    
                    <div class="space-y-2">
                        ${vaga.eventos.map(evt => {
                            const statusClass = normalizeStatus(evt.status || evt.descricao);
                            const statusLabel = getStatusLabel(statusClass);
                            const statusColor = getStatusColor(statusClass);
                            
                            return `
                                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                    <div class="flex justify-between items-start mb-2">
                                        <div>
                                            <span class="font-mono text-sm text-gray-600">${evt.dataInicio.split(' ')[1]}</span>
                                            <span class="text-gray-400 mx-2">‚Üí</span>
                                            <span class="font-mono text-sm text-gray-600">${evt.dataFim.split(' ')[1]}</span>
                                        </div>
                                        <span class="status-badge" style="background: ${statusColor}15; color: ${statusColor}">${statusLabel}</span>
                                    </div>
                                    <p class="text-sm text-gray-700">${evt.descricao}</p>
                                    <p class="text-xs text-gray-500 mt-1">Dura√ß√£o: ${evt.tempoTotal}</p>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }
        
        // ============================================
        // HELPER FUNCTIONS
        // ============================================
        function parseTimeToMinutes(timeStr) {
            if (!timeStr) return 0;
            const parts = timeStr.split(':');
            return parseInt(parts[0]) * 60 + parseInt(parts[1]);
        }
        
        function normalizeStatus(text) {
            if (!text) return 'sem-apropriacao';
            const t = text.toLowerCase();
            if (t.includes('ligado') || t.includes('trabalhando')) return 'trabalhando';
            if (t.includes('desligado') || t.includes('parado')) return 'parado';
            if (t.includes('manuten√ß√£o') || t.includes('manutencao')) return 'manutencao';
            return 'sem-apropriacao';
        }
        
        function getStatusLabel(status) {
            const labels = {
                'trabalhando': 'Trabalhando',
                'parado': 'Parado',
                'manutencao': 'Manuten√ß√£o',
                'sem-apropriacao': 'Sem Apropria√ß√£o'
            };
            return labels[status] || 'Desconhecido';
        }
        
        function getStatusColor(status) {
            const colors = {
                'trabalhando': '#10b981',
                'parado': '#ef4444',
                'manutencao': '#f59e0b',
                'sem-apropriacao': '#9ca3af'
            };
            return colors[status] || '#6b7280';
        }
        
        // ============================================
        // CHARTS
        // ============================================
        function destroyAllCharts() {
            Object.values(state.charts).forEach(c => c && c.destroy());
            state.charts = {};
        }
        
        function renderCharts() {
            if (!state.dashboardData) return;
            destroyAllCharts();
            
            renderStatusChart();
            renderTrendChart();
            renderEfficiencyChart();
        }
        
        function renderStatusChart() {
            const ctx = document.getElementById('statusChart')?.getContext('2d');
            if (!ctx) return;
            
            const data = state.dashboardData.statusDistribution;
            
            state.charts.status = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data).map(getStatusLabel),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: Object.keys(data).map(getStatusColor),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }
        
        function renderTrendChart() {
            const ctx = document.getElementById('trendChart')?.getContext('2d');
            if (!ctx) return;
            
            const data = state.dashboardData.dailyTrend;
            
            state.charts.trend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => formatDate(d.date)),
                    datasets: [
                        {
                            label: 'Trabalhando',
                            data: data.map(d => d.trabalhando),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Parado',
                            data: data.map(d => d.parado),
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    }
                }
            });
        }
        
        function renderEfficiencyChart() {
            const ctx = document.getElementById('efficiencyChart')?.getContext('2d');
            if (!ctx) return;
            
            const data = state.dashboardData.efficiency;
            
            state.charts.efficiency = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.vaga),
                    datasets: [{
                        label: 'Efici√™ncia (%)',
                        data: data.map(d => d.percentage),
                        backgroundColor: data.map(d => d.percentage >= 80 ? '#10b981' : d.percentage >= 60 ? '#f59e0b' : '#ef4444'),
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { max: 100 }
                    }
                }
            });
        }
        
        // ============================================
        // RENDER FUNCTIONS
        // ============================================
        function render() {
            const app = document.getElementById('app');
            app.innerHTML = `
                ${renderSidebar()}
                <div class="main-content ${state.sidebarOpen ? '' : 'expanded'}">
                    ${renderHeader()}
                    ${renderContent()}
                </div>
            `;
        }
        
        function renderSidebar() {
            return `
                <aside class="sidebar ${state.sidebarOpen ? '' : 'closed'}">
                    <div class="p-6">
                        <div class="flex items-center gap-3 mb-8">
                            <div class="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center">
                                <span class="text-white font-bold text-2xl">M</span>
                            </div>
                            <div>
                                <h1 class="text-white font-bold text-lg">MasterDrive</h1>
                                <p class="text-blue-200 text-xs">Sistema de Telemetria</p>
                            </div>
                        </div>
                        
                        <nav class="space-y-2">
                            ${renderNavItem('dashboard', 'Dashboard', `
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            `)}
                            ${renderNavItem('monitoring', 'Monitoramento', `
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            `)}
                            ${renderNavItem('alerts', 'Alertas', `
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                                </svg>
                            `, state.alerts.length)}
                            ${renderNavItem('settings', 'Configura√ß√µes', `
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                            `)}
                        </nav>
                    </div>
                    
                    <div class="absolute bottom-0 left-0 right-0 p-6 border-t border-blue-900">
                        <a href="https://docs.google.com/spreadsheets/d/SEU_ID_AQUI" target="_blank" class="flex items-center gap-3 text-blue-200 hover:text-white transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path>
                            </svg>
                            <span class="text-sm font-medium">Ver Banco de Dados</span>
                        </a>
                    </div>
                </aside>
            `;
        }
        
        function renderNavItem(view, label, icon, badge = null) {
            const isActive = state.view === view;
            return `
                <button onclick="navigateTo('${view}')" class="w-full flex items-center justify-between gap-3 px-4 py-3 rounded-lg transition-all ${isActive ? 'bg-blue-600 text-white' : 'text-blue-100 hover:bg-blue-900'}">
                    <div class="flex items-center gap-3">
                        ${icon}
                        <span class="font-medium">${label}</span>
                    </div>
                    ${badge ? `<span class="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full">${badge}</span>` : ''}
                </button>
            `;
        }
        
        function renderHeader() {
            return `
                <header class="bg-white border-b border-gray-200 sticky top-0 z-40">
                    <div class="px-6 py-4 flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <button onclick="toggleSidebar()" class="p-2 hover:bg-gray-100 rounded-lg md:hidden">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                                </svg>
                            </button>
                            <div>
                                <h2 class="text-xl font-bold text-gray-900">${getTitleForView()}</h2>
                                <p class="text-sm text-gray-500">${new Date().toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-3">
                            <button onclick="loadVagas()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                <span class="hidden sm:inline">Atualizar</span>
                            </button>
                        </div>
                    </div>
                </header>
            `;
        }
        
        function getTitleForView() {
            const titles = {
                'dashboard': 'Dashboard',
                'monitoring': 'Monitoramento em Tempo Real',
                'alerts': 'Central de Alertas',
                'settings': 'Configura√ß√µes do Sistema'
            };
            return titles[state.view] || 'MasterDrive';
        }
        
        function renderContent() {
            switch(state.view) {
                case 'dashboard': return renderDashboardView();
                case 'monitoring': return renderMonitoringView();
                case 'alerts': return renderAlertsView();
                case 'settings': return renderSettingsView();
                default: return '<div></div>';
            }
        }
        
        function renderDashboardView() {
            if (!state.dashboardData) {
                return '<div class="p-8 text-center"><div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto"></div><p class="mt-4 text-gray-500">Carregando dashboard...</p></div>';
            }
            
            return `
                <main class="p-6 max-w-7xl mx-auto">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                        ${renderStatCard('Total de Vagas', state.dashboardData.totalVagas, 'blue', `
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                            </svg>
                        `)}
                        ${renderStatCard('Trabalhando', state.dashboardData.statusDistribution.trabalhando || 0, 'green', `
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        `)}
                        ${renderStatCard('Parado', state.dashboardData.statusDistribution.parado || 0, 'red', `
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        `)}
                        ${renderStatCard('Alertas Ativos', state.alerts.length, 'yellow', `
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                        `)}
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            <h3 class="font-bold text-gray-700 mb-4">Distribui√ß√£o de Status</h3>
                            <div class="chart-container"><canvas id="statusChart"></canvas></div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            <h3 class="font-bold text-gray-700 mb-4">Tend√™ncia Semanal</h3>
                            <div class="chart-container"><canvas id="trendChart"></canvas></div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            <h3 class="font-bold text-gray-700 mb-4">Efici√™ncia por Vaga</h3>
                            <div class="chart-container"><canvas id="efficiencyChart"></canvas></div>
                        </div>
                    </div>
                </main>
            `;
        }
        
        function renderStatCard(label, value, color, icon) {
            const colors = {
                blue: 'bg-blue-100 text-blue-600',
                green: 'bg-green-100 text-green-600',
                red: 'bg-red-100 text-red-600',
                yellow: 'bg-yellow-100 text-yellow-600'
            };
            
            return `
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600 mb-1">${label}</p>
                            <p class="text-3xl font-bold text-gray-900">${value}</p>
                        </div>
                        <div class="${colors[color]} p-4 rounded-xl">
                            ${icon}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderMonitoringView() {
            const filtered = state.vagas.filter(v => {
                const matchSearch = !state.filters.search || v.nome.toLowerCase().includes(state.filters.search.toLowerCase());
                const matchStatus = state.filters.status === 'all' || normalizeStatus(v.status) === state.filters.status;
                return matchSearch && matchStatus;
            });
            
            return `
                <main class="p-6 max-w-7xl mx-auto">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-6">
                        <div class="flex flex-wrap gap-4">
                            <input type="text" placeholder="Buscar vaga..." oninput="state.filters.search = this.value; render()" class="flex-1 min-w-[200px] px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            
                            <select onchange="state.filters.status = this.value; render()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="all">Todos Status</option>
                                <option value="trabalhando">Trabalhando</option>
                                <option value="parado">Parado</option>
                                <option value="manutencao">Manuten√ß√£o</option>
                                <option value="sem-apropriacao">Sem Apropria√ß√£o</option>
                            </select>
                            
                            <input type="date" value="${state.selectedDate}" onchange="state.selectedDate = this.value; loadVagas()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                    </div>
                    
                    ${filtered.length === 0 ? '<p class="text-center py-12 text-gray-500">Nenhuma vaga encontrada</p>' : `
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${filtered.map(renderVagaCard).join('')}
                        </div>
                    `}
                </main>
            `;
        }
        
        function renderVagaCard(vaga) {
            const status = normalizeStatus(vaga.status);
            const statusLabel = getStatusLabel(status);
            const statusColor = getStatusColor(status);
            
            return `
                <div class="vaga-card p-6" onclick='showTimeline(${JSON.stringify(vaga)})'>
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="font-bold text-gray-900 text-lg">${vaga.nome}</h3>
                            <p class="text-sm text-gray-500">${vaga.equipamento || 'Sem equipamento'}</p>
                        </div>
                        <span class="status-badge" style="background: ${statusColor}15; color: ${statusColor}">${statusLabel}</span>
                    </div>
                    
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Hor√°rio:</span>
                            <span class="font-semibold text-gray-900">${vaga.horario || '-'}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">√öltima Atualiza√ß√£o:</span>
                            <span class="font-semibold text-gray-900">${vaga.ultimaAtualizacao ? formatDateTime(vaga.ultimaAtualizacao) : '-'}</span>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-gray-100">
                        <button class="w-full py-2 text-blue-600 font-medium hover:bg-blue-50 rounded-lg transition-colors text-sm flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Ver Timeline
                        </button>
                    </div>
                </div>
            `;
        }
        
        function renderAlertsView() {
            return `
                <main class="p-6 max-w-4xl mx-auto">
                    ${state.alerts.length === 0 ? `
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-12 text-center">
                            <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <h3 class="text-lg font-bold text-gray-900 mb-2">Nenhum alerta ativo</h3>
                            <p class="text-gray-500">Tudo est√° funcionando normalmente</p>
                        </div>
                    ` : `
                        <div class="space-y-4">
                            ${state.alerts.map(renderAlertCard).join('')}
                        </div>
                    `}
                </main>
            `;
        }
        
        function renderAlertCard(alert) {
            const severityClass = alert.severity === 'critical' ? 'alert-critical' : alert.severity === 'warning' ? 'alert-warning' : 'alert-info';
            const severityIcon = alert.severity === 'critical' ? 'üî¥' : alert.severity === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            
            return `
                <div class="alert-card ${severityClass}">
                    <div class="flex items-start gap-4">
                        <span class="text-2xl">${severityIcon}</span>
                        <div class="flex-1">
                            <h3 class="font-bold text-gray-900 mb-1">${alert.title}</h3>
                            <p class="text-sm text-gray-600 mb-2">${alert.message}</p>
                            <div class="flex gap-4 text-xs text-gray-500">
                                <span>Vaga: ${alert.vaga}</span>
                                <span>‚Ä¢</span>
                                <span>${formatDateTime(alert.timestamp)}</span>
                            </div>
                        </div>
                        <button onclick="dismissAlert('${alert.id}')" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
        }
        
        function renderSettingsView() {
            return `
                <main class="p-6 max-w-4xl mx-auto">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                        <h3 class="font-bold text-gray-900 text-lg mb-4">Regras de Alerta</h3>
                        <div class="space-y-4">
                            ${renderRuleForm()}
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <h3 class="font-bold text-gray-900 text-lg mb-4">Regras Ativas</h3>
                        <div class="space-y-3">
                            ${state.rules.length === 0 ? '<p class="text-gray-500 text-center py-8">Nenhuma regra configurada</p>' : state.rules.map(renderRuleItem).join('')}
                        </div>
                    </div>
                </main>
            `;
        }
        
        function renderRuleForm() {
            return `
                <form onsubmit="handleRuleSubmit(event)" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Regra</label>
                            <input type="text" name="name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Condi√ß√£o</label>
                            <select name="condition" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="parado_mais_que">Parado h√° mais de</option>
                                <option value="sem_apropriacao_mais_que">Sem apropria√ß√£o h√° mais de</option>
                                <option value="manutencao_mais_que">Em manuten√ß√£o h√° mais de</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tempo (horas)</label>
                            <input type="number" name="time" min="1" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Severidade</label>
                            <select name="severity" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="info">Informa√ß√£o</option>
                                <option value="warning">Aten√ß√£o</option>
                                <option value="critical">Cr√≠tico</option>
                            </select>
                        </div>
                    </div>
                    
                    <button type="submit" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
                        Adicionar Regra
                    </button>
                </form>
            `;
        }
        
        function renderRuleItem(rule) {
            return `
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <div>
                        <h4 class="font-semibold text-gray-900">${rule.name}</h4>
                        <p class="text-sm text-gray-600">${rule.condition} ${rule.time}h - Severidade: ${rule.severity}</p>
                    </div>
                    <button onclick="deleteRule('${rule.id}')" class="text-red-500 hover:text-red-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                </div>
            `;
        }
        
        // ============================================
        // EVENT HANDLERS
        // ============================================
        async function handleRuleSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const rule = {
                id: 'RULE-' + Date.now(),
                name: formData.get('name'),
                condition: formData.get('condition'),
                time: parseInt(formData.get('time')),
                severity: formData.get('severity'),
                active: true
            };
            
            await saveRule(rule);
            e.target.reset();
        }
        
        async function deleteRule(id) {
            if (confirm('Deseja realmente excluir esta regra?')) {
                // Implement delete logic
                Toast.success('Regra exclu√≠da');
            }
        }
        
        async function dismissAlert(id) {
            // Implement dismiss logic
            state.alerts = state.alerts.filter(a => a.id !== id);
            render();
            Toast.info('Alerta dismissado');
        }
        
        // ============================================
        // INITIALIZATION
        // ============================================
        window.addEventListener('DOMContentLoaded', () => {
            if (!CONFIG.API_URL || CONFIG.API_URL.includes('COLE_AQUI')) {
                Toast.warning('Configure a URL do Apps Script no c√≥digo');
                // Mock data for development
                state.vagas = [
                    { nome: 'ALTA PRESS√ÉO - GPS - 01', equipamento: 'EAM3262', status: 'Trabalhando', horario: '16:08:00', ultimaAtualizacao: new Date(), eventos: [] },
                    { nome: 'ALTA PRESS√ÉO - GPS - 03', equipamento: 'EGC2989', status: 'Parado', horario: '16:08:00', ultimaAtualizacao: new Date(), eventos: [] },
                ];
                state.dashboardData = {
                    totalVagas: 10,
                    statusDistribution: { trabalhando: 5, parado: 3, manutencao: 1, 'sem-apropriacao': 1 },
                    dailyTrend: [],
                    efficiency: []
                };
                state.alerts = [
                    { id: '1', title: 'Equipamento Parado', message: 'EAM3262 est√° parado h√° 2 horas', vaga: 'ALTA PRESS√ÉO - GPS - 01', severity: 'warning', timestamp: new Date() }
                ];
            } else {
                navigateTo('monitoring');
            }
            
            render();
            
            // Auto refresh
            setInterval(() => {
                if (state.view === 'monitoring') loadVagas();
            }, CONFIG.REFRESH_INTERVAL);
        });
    </script>
</body>
</html>
